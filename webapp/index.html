<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Taliesin test page</title>
		<link href="favicon.ico" rel="icon" type="image/x-icon" />
		<meta name="description" content="Taliesin test page">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="css/bootstrap.min.css">
		<script src="js/jquery-3.1.1.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
	</head>
	<body>
		<div style="position: fixed; top: 0; right: 0; padding: 10px;">
			<div id="message" class="alert fade in" style="display:none;">
				<span id="message-content"></span>
			</div>
		</div>
		<div class="container" style="margin-bottom: 20px;margin-top: 20px">
			<div class="row">
				<div class="col-md-2">
					<label for="oauth-token">Oauth Token:</label>
				</div>
				<div class="col-md-2">
					<input type="text" name="oauth-token-value" id="oauth-token-value" placeholder="Enter Glewlwyd Oauth2 access token" class="form-control">
				</div>
				<div class="col-md-2">
					<button type="button" class="btn btn-primary" id="oauth-token-button">Load</button>
				</div>
				<div class="col-md-6">
					<div class="input-group">
						<input type="text" class="form-control" placeholder="Search" name="search-term" id="search-term">
						<div class="input-group-btn">
							<button class="btn btn-default" type="button" id="search-run"><i class="glyphicon glyphicon-search"></i></button>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<h3>
						Stream List
					</h3>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
          <div>
            <button type="button" class="btn btn-primary" id="stream-list-reload">Reload stream list</button>
            <button type="button" class="btn btn-primary" id="stream-disconnect">Disconnect stream</button>
          </div>
          <div>
						<div class="checkbox-inline">
							<label for="stream-connect-websocket"><input type="checkbox" id="stream-connect-websocket">Connect via websocket</label>
						</div>
          </div>
					<select id="stream-list-select" class="form-control" size="5"></select>
				</div>
				<div class="col-md-6">
          <div>
            <button type="button" class="btn btn-primary" id="playlist-list-reload">Refresh playlists</button>
            <button type="button" class="btn btn-primary" id="playlist-list-load">Load as jukebox</button>
            <button type="button" class="btn btn-primary" id="playlist-list-load-webradio">Load as webradio</button>
            <button type="button" class="btn btn-primary" id="playlist-list-edit">Edit playlist</button>
            <button type="button" class="btn btn-primary" id="playlist-list-delete">Delete playlist</button>
          </div>
          <select id="playlist-list-select" class="form-control" size="5"></select>
				</div>
			</div>
			<div class="row" style="margin-top: 10px;">
				<div class="col-md-6">
					<div id="media-player-audio-container">
					</div>
					<div class="btn-group">
						<button type="button" class="btn btn-primary" title="replay" id="media-player-replay">
							<span class="glyphicon glyphicon-fast-backward"></span>
						</button>
						<button type="button" class="btn btn-primary" title="stop" id="media-player-stop">
							<span class="glyphicon glyphicon-stop"></span>
						</button>
						<button type="button" class="btn btn-primary" title="play" id="media-player-play">
							<span class="glyphicon glyphicon-play"></span>
						</button>
						<button type="button" class="btn btn-primary" title="pause" id="media-player-pause">
							<span class="glyphicon glyphicon-pause"></span>
						</button>
						<button type="button" class="btn btn-primary" title="skip" id="media-player-skip">
							<span class="glyphicon glyphicon-fast-forward"></span>
						</button>
						<button type="button" class="btn btn-primary" title="close" id="media-player-close">
							<span class="glyphicon glyphicon-trash"></span>
						</button>
						<button type="button" class="btn btn-primary" title="save" id="media-player-save">
							<span class="glyphicon glyphicon-floppy-save"></span>
						</button>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Webradio</label>
						</div>
						<div class="col-md-6">
							<span id="stream-current-webradio"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Random</label>
						</div>
						<div class="col-md-6">
							<span id="stream-current-random"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Format</label>
						</div>
						<div class="col-md-6">
							<span id="stream-current-format"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Channels</label>
						</div>
						<div class="col-md-6">
							<span id="stream-current-channels"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Bitrate</label>
						</div>
						<div class="col-md-6">
							<span id="stream-current-bitrate"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Sample rate</label>
						</div>
						<div class="col-md-6">
							<span id="stream-current-sample-rate"></span>
						</div>
					</div>
					<div>
						<a id="media-player-stream-url" href="" download>Stream url link</a>
					</div>
					<div>
						<a id="media-player-stream-url-playlist" href="">Open in exterrnal player</a>
					</div>
				</div>
				<div class="col-md-6" id="stream-current-container">
					<div class="row">
						<div class="col-md-6">
							<label>
								Refresh
							</label>
						</div>
						<div class="col-md-6">
							<button type="button" id="stream-current-refresh" class="btn btn-primary btn-xs">
								<span class="glyphicon glyphicon-refresh"></span>
							</button>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>
								Name
							</label>
						</div>
						<div class="col-md-6">
							<span id="stream-current-display-name"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>
								Now playing
							</label>
						</div>
						<div class="col-md-6">
							<span id="stream-current-now-playing"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>
								Next playing
							</label>
						</div>
						<div class="col-md-6">
							<span id="stream-current-next-playing"></span>
						</div>
					</div>
          <div class="row">
						<div class="col-md-6">
							<label>
								Current stream cover
							</label>
						</div>
            <div class="col-md-6">
              <img id="stream-cover" src="" alt="no stream cover" style="width:100%;max-width:300px;height:100%;max-height:300px;" />
            </div>
          </div>
				</div>
			</div>
			<div class="row">
				<div class="col-md-2">
					<div><h2>Data sources</h2></div>
					<div>
						<select size="5" id="data-source-list" class="form-control"></select>
					</div>
					<div>
						<button type="button" id="data-source-button-new" class="btn btn-primary">New</button>
					</div>
				</div>
				<div class="col-md-4" style="display:none;" id="data-source-details">
					<div class="row">
						<h3>Details</h3>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Name</label>
						</div>
						<div class="col-md-6">
							<span id="data-source-details-name"></span>
							<input type="text" id="data-source-details-name-edit" placeholder="Data source name" style="display:none;" class="form-control">
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Description</label>
						</div>
						<div class="col-md-6">
							<span id="data-source-details-description"></span>
							<input type="text" id="data-source-details-description-edit" placeholder="Data source description" style="display:none;" class="form-control">
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Path</label>
						</div>
						<div class="col-md-6">
							<span id="data-source-details-path"></span>
							<input type="text" id="data-source-details-path-edit" placeholder="Enter valid path" style="display:none;" class="form-control">
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Scope</label>
						</div>
						<div class="col-md-6">
							<span id="data-source-details-scope"></span>
							<div class="checkbox-inline" style="display:none;" id="data-source-details-scope-edit-block">
								<label for="data-source-details-scope-edit"><input type="checkbox" id="data-source-details-scope-edit">Private</label>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6">
							<label>Last Updated</label>
						</div>
						<div class="col-md-6">
							<span id="data-source-details-last-updated"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
							<button type="button" id="data-source-button-modify" class="btn btn-primary">Modify</button>
							<button type="button" id="data-source-button-save" class="btn btn-primary" style="display:none;">Save</button>
							<button type="button" id="data-source-button-cancel" class="btn btn-primary" style="display:none;">Cancel</button>
						</div>
					</div>
				</div>
				<div class="col-md-4" style="display:none;" id="data-source-refresh-container">
					<div class="row">
						<h3>Refresh status</h3>
					</div>
					<div class="row">
						<span id="data-source-refresh-status"></span>
					</div>
					<div class="row">
						<button type="button" class="btn btn-primary" id="data-source-refresh">refresh</button>
						<button type="button" class="btn btn-primary" id="data-source-stop-refresh">stop refresh</button>
						<button type="button" class="btn btn-primary" id="data-source-clean">clean</button>
					</div>
				</div>
			</div>
			<div class="row" style="display:none;" id="data-source-browse">
				<div class="col-md-4">
					<div><h2>Elements</h2></div>
					<div class="btn-group">
						<button type="button" class="btn btn-primary browse-type" title="path" data-browse-type="path" id="data-source-browse-path">
							Path
						</button>
						<button type="button" class="btn btn-primary browse-type" title="artist" data-browse-type="artist" id="data-source-browse-artist">
							Artist
						</button>
						<button type="button" class="btn btn-primary browse-type" title="album" data-browse-type="album" id="data-source-browse-album">
							Album
						</button>
						<button type="button" class="btn btn-primary browse-type" title="year" data-browse-type="year" id="data-source-browse-year">
							Year
						</button>
						<button type="button" class="btn btn-primary browse-type" title="genre" data-browse-type="genre" id="data-source-browse-genre">
							Genre
						</button>
            <select class="form-control" id="browse-source-browse-sublevel">
              <option value="list">List</option>
              <option value="artist">Sublevel: Artist</option>
              <option value="album">Sublevel: Album</option>
              <option value="year">Sublevel: Year</option>
              <option value="genre">Sublevel: Genre</option>
            </select>
					</div>
					<div>
						<label>Current folder:</label>
						<span id="data-source-current-folder"></span>
					</div>
					<div>
						<select size="5" id="data-source-browse-list" multiple class="form-control"></select>
					</div>
					<div>
						<img alt="cover thumb" src="" id="data-source-media-cover-thumb" />
					</div>
					<div>
						<img alt="cover full" src="" id="data-source-media-cover-full" style="width:100%;max-width:300px;height:100%;max-height:300px;"/>
					</div>
				</div>
				<div class="col-md-4" style="display:none;" id="data-source-browse-details">
					<div class="row">
						<h3>Details</h3>
					</div>
					<div class="row">
						<div class="col-md-3">
							<label>Name</label>
						</div>
						<div class="col-md-9">
							<span id="data-source-browse-details-name"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-3">
							<label>Type</label>
						</div>
						<div class="col-md-9">
							<span id="data-source-browse-details-type"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-3">
							<label>Last updated</label>
						</div>
						<div class="col-md-9">
							<span id="data-source-browse-details-last-updated"></span>
						</div>
					</div>
					<div class="row">
						<div class="col-md-12">
              <button type="button" id="media-play-webradio" class="btn btn-primary">Webradio</button>
              <button type="button" id="media-play-list" class="btn btn-primary">Jukebox</button>
              <button type="button" id="media-add-to-stream" class="btn btn-primary">Add to current stream</button>
              <button type="button" id="media-add-to-playlist" class="btn btn-primary">Add to current playlist</button>
              <div class="input-group">
                <div class="checkbox-inline">
									<label for="media-play-auto-play"><input type="checkbox" checked="true" id="media-play-auto-play">Auto play</label>
                </div>
                <div class="checkbox-inline">
									<label for="media-play-recursive"><input type="checkbox" checked="true" id="media-play-recursive">Recursive</label>
                </div>
							</div>
							<div class="input-group">
                <div class="checkbox-inline">
									<label for="media-play-random"><input type="checkbox" id="media-play-random">Random</label>
                </div>
              </div>
							<div>
								<label for="media-play-format">Format:</label>
								<select class="form-control" id="media-play-format">
									<option value="mp3" selected>MP3</option>
									<option value="vorbis">Vorbis</option>
									<!--<option value="aac">AAC</option>-->
									<option value="flac">FLAC</option>
								</select>
							</div>
							<div>
								<label for="media-play-channels">Chanels:</label>
								<select class="form-control" id="media-play-channels">
									<option value="1">Mono</option>
									<option value="2" selected>Stereo</option>
								</select>
							</div>
							<div>
								<label for="media-play-sample-rate">Sample rate:</label>
								<select class="form-control" id="media-play-sample-rate">
									<option value="8000">8KHz</option>
									<option value="11025">11 KHz</option>
									<option value="22050">22 KHz</option>
									<option value="32000">32 KHz</option>
									<option value="44100" selected>44 KHz</option>
									<option value="48000">48 KHz</option>
								</select>
							</div>
							<div>
								<label for="media-play-bit-rate">Bitrate:</label>
								<select class="form-control" id="media-play-bit-rate">
									<option value="32000">32 kbps</option>
									<option value="96000">96 kbps</option>
									<option value="128000" selected>128 kbps</option>
									<option value="192000">192 kbps</option>
									<option value="256000">256 kbps</option>
									<option value="320000">320 kbps</option>
								</select>
							</div>
						</div>
					</div>
					<div class="row">
						<h3>Tags <button type="button" id="data-source-browse-details-tags-show" class="btn btn-small btn-primary">Show/Hide</button></h3>
					</div>
					<div class="row">
						<div class="col-md-12">
							<span id="data-source-browse-details-tags" style="display:none;"></span>
						</div>
					</div>
				</div>
			</div>
      <div class="row">
        <div class="col-md-6">
          <div class="row">
						<div class="col-md-2">
							<label>
								Playlist
							</label>
						</div>
						<div class="col-md-2">
							<button type="button" id="stream-list-toggle" class="btn btn-primary">Show/Hide</button>
						</div>
					</div>
					<div class="row">
            <div class="col-md-12" style="display: block; height: 270px; overflow-y: scroll;">
							<ul id="stream-list" class="list-group">
							</ul>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="row">
						<div class="col-md-2">
							<label>
								History
							</label>
						</div>
						<div class="col-md-2">
							<button type="button" id="stream-history-toggle" class="btn btn-primary">Show/Hide</button>
						</div>
					</div>
					<div class="row">
            <div class="col-md-12" style="display: block; height: 270px; overflow-y: scroll;">
							<ul id="stream-history" class="list-group">
							</ul>
            </div>
          </div>
        </div>
      </div>
		</div>
		<div class="hidden">
			<a id="hidden-anchor" href=""></a>
		</div>
	</body>
  <div id="modal-playlist" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Save playlist</h4>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <legend for="modal-playlist-name">Name</legend>
            </div>
            <div class="col-md-6">
              <input type="text" name="modal-playlist-name" id="modal-playlist-name" placeholder="Playlist name">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <legend for="modal-playlist-description">Description</legend>
            </div>
            <div class="col-md-6">
              <input type="text" name="modal-playlist-description" id="modal-playlist-description" placeholder="Playlist description">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" id="modal-playlist-save">Save</button>
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
<script>
	var dataSourceList = {};
	var pathElements = {};
	var currentDataSource = "";
	var dataSourceEdit = false;
	var currentPath = "";
	var currentElementList = [];
	var currentStream = {};
	var streamList = {};
	var streamWebsocket = {};
	var currentList = [];
	var currentListIndex = 0;
  var playlistList = {};
  var currentPlaylist = false;
  var updatePlaylist = false;
	var browseType = "path";
	
	$("#oauth-token-button").click(function () {
		loadDataSources();
		refreshStreamList();
    refreshPlaylistList();
	});
	
	$("#data-source-list").change(function () {
		if ($(this).val()) {
			var dataSource = dataSourceList[$(this).val()];
			$("#data-source-details-name").html(dataSource.name);
			$("#data-source-details-description").html(dataSource.description);
			$("#data-source-details-path").html(dataSource.path);
			$("#data-source-details-scope").html(dataSource.scope);
			$("#data-source-details-last-updated").html((new Date(dataSource.last_updated * 1000)).toLocaleString());
			$("#data-source-details").fadeIn();
			$("#data-source-refresh-container").fadeIn();
			currentDataSource = dataSource.name;
			loadDataSourceElements("");
			loadRefreshStatus();
		}
	});
	
	$("#data-source-browse-list").change(function () {
		currentElementList = [];
		if ($(this).val().length > 1) {
			//$("#data-source-browse-details").hide();
			var eltList = $(this).val();
			for (var i in eltList) {
				var element = pathElements[eltList[i]];
				if (element && element.type !== "folder") {
					currentElementList.push(element);
				}
			}
		} else {
			var element = pathElements[$(this).val()];
      currentElementList.push(element);
      $("#data-source-browse-details-name").html(element.name);
      $("#data-source-browse-details-type").html(element.type);
      $("#data-source-browse-details-last-updated").html((new Date(element.last_updated * 1000)).toLocaleString());
      $("#data-source-browse-details-tags").html(displayTags(element.tags));
      $("#data-source-browse-details").fadeIn();
			$("#data-source-media-cover-full").attr("src", "");
			$("#data-source-media-cover-full").attr("alt", "loading cover...");
			$("#data-source-media-cover-thumb").attr("src", "");
			$("#data-source-media-cover-thumb").attr("alt", "loading thumb...");
      console.log(element);
			$.ajax({
				type: "GET",
				url: "../api/data_source/" + currentDataSource + "/browse/" + browseType + "/" + (element.path||(currentPath + element.name)) + "?cover&base64",
				beforeSend: function(request) {
					request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
				},
				success: function (result, status, request) {
					var dataURL = "data:image/jpeg;base64,"+result;
					$("#data-source-media-cover-full").attr("src", dataURL);
          $("#data-source-media-cover-full").attr("alt", "cover full");
				},
				error: function (error) {
					if (error.status !== 404) {
						showMessage("warning", "Error loading cover: " + error.status + " - " + error.statusText);
					}
          $("#data-source-media-cover-full").attr("src", "");
          $("#data-source-media-cover-full").attr("alt", "no cover");
				}
			});
			$.ajax({
				type: "GET",
				url: "../api/data_source/" + currentDataSource + "/browse/" + browseType + "/" + (element.path||(currentPath + element.name)) + "?cover&thumbnail&base64",
				beforeSend: function(request) {
					request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
				},
				success: function (result, status, request) {
					var dataURL = "data:image/jpeg;base64,"+result;
					$("#data-source-media-cover-thumb").attr("src", dataURL);
          $("#data-source-media-cover-thumb").attr("alt", "cover thumb");
				},
				error: function (error) {
					if (error.status !== 404) {
						showMessage("warning", "Error loading cover: " + error.status + " - " + error.statusText);
					}
          $("#data-source-media-cover-thumb").attr("src", "");
          $("#data-source-media-cover-thumb").attr("alt", "no cover thumb");
				}
			});
		}
	});
	
	$("#data-source-browse-list").dblclick(function () {
		var element = pathElements[$(this).val()[0]];
		if ($(this).val()[0] === ".." || (element && (element.type === "folder" || element.type === "artist" || element.type === "album" || element.type === "year" || element.type === "genre" || element.type === "tag"))) {
			currentElement = {};
			$("#data-source-browse-details").hide();
			if ($(this).val()[0] === "..") {
				loadDataSourceElements(currentPath.substring(0, currentPath.lastIndexOf("/")));
			} else {
				loadDataSourceElements(currentPath + "/" + element.name);
			}
		}
	});
	
	$("#data-source-browse-details-tags-show").click(function () {
		$("#data-source-browse-details-tags").fadeToggle();
	});
	
	$("#data-source-stop-refresh").click(function () {
		$.ajax({
			type: "DELETE",
			url: "../api/data_source/" + currentDataSource + "/refresh",
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				loadRefreshStatus();
			},
			error: function (error) {
			  showMessage("warning", "Error stop refresh data source: " + error.status + " - " + error.statusText);
			}
		});
	});
	
	$("#data-source-clean").click(function () {
		$.ajax({
			type: "POST",
			url: "../api/data_source/" + currentDataSource + "/clean",
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
			  loadRefreshStatus();
			},
			error: function (error) {
			  showMessage("warning", "Error clean data source: " + error.status + " - " + error.statusText);
			}
		});
	});
	
	$("#data-source-refresh").click(function () {
		$.ajax({
			type: "PUT",
			url: "../api/data_source/" + currentDataSource + "/refresh/" + currentPath,
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				loadRefreshStatus();
			},
			error: function (error) {
			  showMessage("warning", "Error refresh data source: " + error.status + " - " + error.statusText);
			}
		});
	});
	
	$("#media-play-webradio").click(function () {
		if (currentElementList.length == 1) {
			var path = (currentPath?currentPath + "/":"");
			$.ajax({
				type: "GET",
				url: "../api/data_source/" + currentDataSource + "/browse/path/" + currentPath + "/" + currentElementList[0].name +
						 "?webradio&format=" + $("#media-play-format").val() + "&channels=" + $("#media-play-channels").val() +
						 "&samplerate=" + $("#media-play-sample-rate").val() + "&bitrate=" + $("#media-play-bit-rate").val() +
						 ($("#media-play-recursive").prop("checked")?"&recursive":"") +
						 ($("#media-play-random").prop("checked")?"&random":""),
				beforeSend: function(request) {
					request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
				},
				success: function (result, status, request) {
					$("#media-player-stream-url").show().attr("href", "../api/stream/" + result.name);
					$("#media-player-stream-url-playlist").show().attr("href", buildWebradioPlaylist(result.name)).attr("download", result.display_name + ".m3u");
					$("#media-player-audio-container").empty();
					if ($("#media-play-auto-play").prop("checked")) {
						$("#media-player-audio-container").html("<audio controls preload=\"none\" id=\"media-player-audio\"></audio>");
						$("#media-player-audio").attr("src", "../api/stream/" + result.name).attr("data-stream-name", result.name);
						$("#media-player-audio").trigger("play");
					}
					refreshStreamList(result.name);
				},
				error: function (error) {
					showMessage("warning", "Error play media: " + error.status + " - " + error.statusText);
				}
			});
		}
	});
  
  $("#media-play-list").click(function () {
		if (currentElementList.length == 1) {
			var path = (currentPath?currentPath + "/":"");
			$.ajax({
				type: "GET",
				url: "../api/data_source/" + currentDataSource + "/browse/path/" + currentPath + "/" + currentElementList[0].name +
						 "?jukebox&format=" + $("#media-play-format").val() + "&channels=" + $("#media-play-channels").val() +
						 "&samplerate=" + $("#media-play-sample-rate").val() + "&bitrate=" + $("#media-play-bit-rate").val() +
						 ($("#media-play-recursive").prop("checked")?"&recursive":""),
				beforeSend: function(request) {
					request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
				},
				success: function (result, status, request) {
					$("#media-player-stream-url").hide();
					$("#media-player-audio-container").empty();
					$("#media-player-stream-url-playlist").show().attr("href", "../api/stream/" + result.name);
					if ($("#media-play-auto-play").prop("checked")) {
						$("#media-player-audio-container").html("<audio controls preload=\"none\" id=\"media-player-audio\"></audio>");
						$("#media-player-audio").attr("src", "../api/stream/" + result.name + "?index=0").attr("data-stream-name", result.name);
						$("#media-player-audio").trigger("play");
            $("#media-player-audio").get()[0].onended = function () {
              playNext(index + 1);
            };
					}
					refreshStreamList(result.name);					
				},
				error: function (error) {
					showMessage("warning", "Error play media: " + error.status + " - " + error.statusText);
				}
			});
		}
  });
  
  $("#media-add-to-playlist").click(function () {
    var newMedia = [];
    for (var i in currentElementList) {
      newMedia.push({data_source: currentDataSource, path: currentPath + "/" + currentElementList[i].name, recursive: $("#media-play-recursive").prop("checked")});
    }
    if (newMedia.length > 0) {
			$.ajax({
				type: "PUT",
				url: "../api/playlist/" + currentPlaylist.name + "/add_media",
				beforeSend: function(request) {
					request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
					request.setRequestHeader("content-type", "application/json");
				},
				success: function (result, status, request) {
					showMessage("info", "Media added to playlist");
					refreshPlaylistList();
				},
				error: function (error) {
					showMessage("warning", "Error adding media to playlist: " + error.status + " - " + error.statusText);
				}
			});
    }
  });
	
  $("#media-add-to-stream").click(function () {
    var newMedia = [];
    for (var i in currentElementList) {
      newMedia.push({data_source: currentDataSource, path: currentPath + "/" + currentElementList[i].name, recursive: $("#media-play-recursive").prop("checked")});
    }
    if (newMedia.length > 0) {
      runCommand(currentStream.name, "append_list", newMedia);
    }
  });
	
	$("#data-source-button-new").click(function () {
		dataSourceEdit = false;
		$("#data-source-details").show();
		$("#data-source-details-name-edit").val("");
		$("#data-source-details-name-edit").show();
		$("#data-source-details-name").hide();
		$("#data-source-details-description-edit").val("");
		$("#data-source-details-description-edit").show();
		$("#data-source-details-description").hide();
		$("#data-source-details-path-edit").val("");
		$("#data-source-details-path-edit").show();
		$("#data-source-details-scope-edit").prop("checked", true);
		$("#data-source-details-scope-edit-block").show();
		$("#data-source-details-scope").hide();
		$("#data-source-details-path").hide();
		$("#data-source-button-modify").hide();
		$("#data-source-button-save").show();
		$("#data-source-button-cancel").show();
		loadDataSources();
	});
	
	$("#data-source-button-modify").click(function () {
		dataSourceEdit = true;
		$("#data-source-details-description-edit").val(dataSourceList[currentDataSource].description);
		$("#data-source-details-path-edit").val(dataSourceList[currentDataSource].path);
		$("#data-source-details-description").hide();
		$("#data-source-details-description-edit").show();
		$("#data-source-details-path").hide();
		$("#data-source-details-path-edit").show();
		$("#data-source-button-modify").hide();
		$("#data-source-button-save").show();
		$("#data-source-button-cancel").show();
	});
	
	$("#data-source-button-cancel").click(function () {
		$("#data-source-details-description").html(dataSourceList[currentDataSource].description);
		$("#data-source-details-path").html(dataSourceList[currentDataSource].path);
		$("#data-source-button-save").hide();
		$("#data-source-button-cancel").hide();
		$("#data-source-button-modify").show();
		$("#data-source-details-path-edit").hide();
		$("#data-source-details-path").show();
		$("#data-source-details-description-edit").hide();
		$("#data-source-details-description").show();
		$("#data-source-details-name-edit").hide();
		$("#data-source-details-name").show();
	});
	
	$("#data-source-button-save").click(function () {
		var newDataSource = {
			name: $("#data-source-details-name-edit").val(),
			description: $("#data-source-details-description-edit").val(),
			path: $("#data-source-details-path-edit").val(),
			//icon: dataSourceList[currentDataSource].icon,
			scope: ($("#data-source-details-scope-edit").prop("checked")?"me":"all")
		};
		var method = "PUT";
		var url = "../api/data_source/" + currentDataSource;
		if (!dataSourceEdit) {
			method = "POST";
			url = "../api/data_source/";
		}
		$.ajax({
			type: method,
			url: url,
			data: JSON.stringify(newDataSource),
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
				request.setRequestHeader("content-type", "application/json");
			},
			success: function (result, status, request) {
				if (!dataSourceEdit) {
					currentDataSource = $("#data-source-details-name-edit").val();
					dataSourceList[currentDataSource] = newDataSource;
				} else {
					dataSourceList[currentDataSource].description = newDataSource.description;
					dataSourceList[currentDataSource].path = newDataSource.path;
				}
				$("#data-source-details-description").html(dataSourceList[currentDataSource].description);
				$("#data-source-details-name").html(dataSourceList[currentDataSource].name);
				$("#data-source-details-path").html(dataSourceList[currentDataSource].path);
				$("#data-source-button-save").hide();
				$("#data-source-button-cancel").hide();
				$("#data-source-button-modify").show();
				$("#data-source-details-path-edit").hide();
				$("#data-source-details-path").show();
				$("#data-source-details-description-edit").hide();
				$("#data-source-details-description").show();
				$("#data-source-details-name-edit").hide();
				$("#data-source-details-name").show();
			},
			error: function (error) {
			  showMessage("warning", "Error save data source: " + error.status + " - " + error.statusText);
			}
		});
	});
	
	$("#media-player-stop").click(function () {
		if ($("#media-player-audio").get()[0]) {
			$("#media-player-audio").get()[0].pause();
			$("#media-player-audio").get()[0].currentTime = 0;
			$("#media-player-audio").get()[0].src = URL.createObjectURL(new Blob([], {type:"audio/mp3"}));
			$("#media-player-stream-url").hide();
		}
	});
	
	$("#media-player-play").click(function () {
		if (currentStream.webradio) {
			$("#media-player-audio-container").empty();
			$("#media-player-audio-container").html("<audio controls preload=\"none\" id=\"media-player-audio\"></audio>");
			$("#media-player-audio").attr("src", "../api/stream/" + currentStream.name + "?rand=" + Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5)).attr("data-stream-name", currentStream.name);
			$("#media-player-audio").trigger("play");
			$("#media-player-audio").get()[0].onended = function () {
				playNext(currentListIndex + 1);
			};
		} else {
			playNext(currentListIndex);
		}
	});
	
	$("#media-player-pause").click(function () {
		if (!$("#media-player-audio").get()[0].paused) {
			$("#media-player-audio").get()[0].pause();
		} else {
			$("#media-player-audio").get()[0].play();
		}
	});
	
	$("#stream-list-reload").click(function () {
		refreshStreamList();
	});
	
	$("#playlist-list-reload").click(function () {
		refreshPlaylistList();
	});
  
  $("#playlist-list-load").click(function () {
		$.ajax({
			type: "PUT",
      url: "../api/playlist/" + currentPlaylist.name + "/load",
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				showMessage("info", "playlist loaded");
        refreshPlaylistList();
        refreshStreamList();
			},
			error: function (error) {
			  showMessage("warning", "Error deleting playlist: " + error.status + " - " + error.statusText);
			}
		});
  });
  
  $("#playlist-list-load-webradio").click(function () {
		$.ajax({
			type: "PUT",
			url: "../api/playlist/" + currentPlaylist.name + "/load?webradio&format=" + $("#media-play-format").val() + "&channels=" + $("#media-play-channels").val() +
						 "&samplerate=" + $("#media-play-sample-rate").val() + "&bitrate=" + $("#media-play-bit-rate").val() +
						 ($("#media-play-recursive").prop("checked")?"&recursive":"") +
						 ($("#media-play-random").prop("checked")?"&random":""),
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				showMessage("info", "webradio loaded");
        refreshPlaylistList();
        refreshStreamList();
			},
			error: function (error) {
			  showMessage("warning", "Error deleting playlist: " + error.status + " - " + error.statusText);
			}
		});
  });
  
  $("#playlist-list-edit").click(function () {
    updatePlaylist = true;
    $("#modal-playlist-name").val(currentPlaylist.name).prop("disabled", true);
    $("#modal-playlist-description").val(currentPlaylist.description);
    $("#modal-playlist").modal("show");
  });
  
  $("#playlist-list-delete").click(function () {
		$.ajax({
			type: "DELETE",
			url: "../api/playlist/" + currentPlaylist.name,
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				showMessage("info", "playlist deleted");
        refreshPlaylistList();
			},
			error: function (error) {
			  showMessage("warning", "Error deleting playlist: " + error.status + " - " + error.statusText);
			}
		});
  });
  
  $("#playlist-list-select").change(function () {
    currentPlaylist = playlistList[$(this).val()];
    $("#stream-list").empty();
    var listHeight = Math.floor(Math.log10(currentPlaylist.media.length)+1);
    currentList = currentPlaylist.media;
    for (var i in currentPlaylist.media) {
      $("#stream-list").append(
        $("<li class=\"list-group-item\"></li>").html("<button type=\"button\" class=\"btn btn-primary remove-from-playlist\" data-index=\"" + i + "\">X</button>&nbsp;" +
                                                      currentPlaylist.media[i].data_source + currentPlaylist.media[i].path +
                                                      "<span class=\"badge\">" + pad(i, listHeight) + "</span>")
      );
    }
  });
	
	$("#stream-list-select").change(function () {
    currentStream = streamList[$(this).val()];
    currentPlaylist = false;
		connectSocket(currentStream.name);
		//console.log("select new stream", $(this).val());
	});
	
	$("#media-player-close").click(function () {
		runCommand(currentStream.name, "stop");
	});
	
	$("#media-player-replay").click(function () {
		if (currentStream.webradio) {
			runCommand(currentStream.name, "replay");
		} else {
			playNext(currentListIndex - 1);
		}
	});
	
	$("#media-player-skip").click(function () {
		if (currentStream.webradio) {
			runCommand(currentStream.name, "skip");
		} else {
			playNext(currentListIndex + 1);
		}
	});
	
	$("#stream-disconnect").click(function () {
		closeSocket(currentStream.name);
	});
	
	$("#stream-list-toggle").click(function () {
		$("#stream-list").toggle();
	});
  
	$("#stream-history-toggle").click(function () {
		$("#stream-history").toggle();
	});
  
  $("#media-player-save").click(function () {
    updatePlaylist = false;
    $("#modal-playlist-name").val(currentStream.display_name).prop("disabled", !!currentStream.playlist);
    $("#modal-playlist-description").val(currentStream.display_name);
    $("#modal-playlist").modal("show");
  });
  
  $("#modal-playlist-save").click(function () {
    console.log("plop");
    var playlist = {
      name: $("#modal-playlist-name").val(),
      description: $("#modal-playlist-description").val()
    }
    runCommand(currentStream.name, "save", playlist);
  });
	
	$("#stream-current-refresh").click(function () {
		runCommand(currentStream.name, "info");
		runCommand(currentStream.name, "list");
		if (currentStream.webradio) {
			runCommand(currentStream.name, "history");
			runCommand(currentStream.name, "now");
			runCommand(currentStream.name, "next");
		}
		getStreamCover(currentStream);
	});
	
	$("#search-run").click(function () {
		if ($("#search-term").val()) {
			$.ajax({
				type: "GET",
				url: "../api/search/?q=" + $("#search-term").val(),
				beforeSend: function(request) {
					request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
				},
				success: function (result, status, request) {
					console.log(result)
				},
				error: function (error) {
					showMessage("warning", "Error search: " + error.status + " - " + error.statusText);
				}
			});
		}
	});
	
	$(".browse-type").click(function () {
		browseType = $(this).attr("data-browse-type") || "path";
		pathElements = {};
		currentPath = "";
		loadDataSourceElements("");
	});
  
	function loadDataSources() {
		$.ajax({
			type: "GET",
			url: "../api/data_source/",
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				$("#data-source-list").empty();
				for (var i in result) {
					dataSourceList[result[i].name] = result[i];
					$("#data-source-list").append(
						$("<option></option>").val(result[i].name).html(result[i].name)
					);
				}
			},
			error: function (error) {
			  showMessage("warning", "Error loading data sources: " + error.status + " - " + error.statusText);
			}
		});
	}
	
	function loadRefreshStatus() {
		$.ajax({
			type: "GET",
			url: "../api/data_source/" + currentDataSource + "/refresh",
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				$("#data-source-refresh-status").html(result.status);
				if (result.status === "running") {
					$("#data-source-refresh-status").html(result.status + ": " + (Math.round((result.read * 10000) / result.total) / 100.0) + "%");
					setTimeout(function () {
						loadRefreshStatus();
					}, 2000);
				}
			},
			error: function (error) {
			  showMessage("warning", "Error loading refresh status: " + error.status + " - " + error.statusText);
			}
		});
	}
	
	function loadDataSourceElements(path) {
    var sublevel = "list";
    var subcategory = "";
    var url = "../api/data_source/" + currentDataSource + "/browse/path/" + (path||"");
    if (browseType !== "path") {
      console.log(path, $("#browse-source-browse-sublevel").val());
      url = "../api/data_source/" + currentDataSource + "/browse/category/" + browseType + "/" + (path?path.split("/")[1]:"");
      if (path.split("/")[2]) {
        subcategory = path.split("/")[2];
      }
      if ($("#browse-source-browse-sublevel").val() !== "list" && $("#browse-source-browse-sublevel").val() != browseType) {
        url += "/" + $("#browse-source-browse-sublevel").val() + "/" + subcategory;
      }
    }
		$.ajax({
			type: "GET",
			url: url,
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				$("#data-source-browse-list").empty();
				$("#data-source-browse").fadeIn();
				$("#data-source-browse-list").append(
					$("<option></option>").val(".").html("[.]")
				);
				if (path) {
					$("#data-source-browse-list").append(
						$("<option></option>").val("..").html("[..]")
					);
				}
				$("#data-source-current-folder").html(path||"/");
				currentPath = (path||"");
				pathElements = {".": {name: "", type: "folder"}};
				for (var i in result) {
					pathElements[(path||"/") + result[i].name] = result[i];
					if (result[i].type!=="folder") {
						$("#data-source-browse-list").append(
							$("<option></option>").val((path||"/") + result[i].name).html(result[i].name)
						);
					} else {
						$("#data-source-browse-list").append(
							$("<option></option>").val((path||"/") + result[i].name).html("[" + result[i].name + "]")
						);
					}
				}
			},
			error: function (error) {
				$("#data-source-browse-list").empty();
				if (error.status !== 503) {
					showMessage("warning", "Error loading data source elements: " + error.status + " - " + error.statusText);
				}
			}
		});
	}
	
	function displayTags(tags) {
		var out = "";
		for (var prop in tags) {
      out += "<div class=\"row\"><div class=\"col-md-6\"><label>" + prop + ": </label></div><div class=\"col-md-6\"><span>" + tags[prop] + "</div></span></div>";
		}
		return out;
	}
	
	function showMessage(type, message) {
		$("#message").removeClass().addClass("alert fade in alert-" + type);
		$("#message-content").html(message);
		$("#message").show();
		setTimeout(function () {
			$("#message").hide();
		}, 5000);
	}
	
	function getStreamCover(stream) {
		if (stream.webradio) {
			var coverUrl = "../api/stream/" + stream.name + "/cover?base64";
		} else {
			var coverUrl = "../api/stream/" + stream.name + "/cover?base64&index=" + currentListIndex;
		}
		$.ajax({
			type: "GET",
			url: coverUrl,
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				var dataURL = "data:image/jpeg;base64,"+result;
				$("#stream-cover").attr("src", dataURL);
				$("#stream-cover").attr("alt", "cover thumb");
			},
			error: function (error) {
				if (error.status !== 404) {
					showMessage("warning", "Error loading cover: " + error.status + " - " + error.statusText);
				}
				$("#stream-cover").attr("src", "");
				$("#stream-cover").attr("alt", "no stream cover");
			}
		});
	}
	
	function refreshStreamList(streamName) {
		$("#stream-list").empty();
		$("#stream-history").empty();
		currentList = [];
		$.ajax({
			type: "GET",
			url: "../api/stream/",
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				streamList = {};
				$("#stream-list-select").empty();
				for (var i in result) {
					streamList[result[i].name] = result[i];
					$("#stream-list-select").append(
						$("<option></option>").val(result[i].name).html(result[i].display_name||"No name")
					);
				}
				if (streamName) {
					currentStream = streamList[streamName];
					$("#stream-list-select").val(streamName);
					connectSocket(streamName);
				}
			},
			error: function (error) {
				showMessage("warning", "Error loading stream list: " + error.status + " - " + error.statusText);
			}
		});
	}
  
  function refreshPlaylistList(playlistName) {
		$.ajax({
			type: "GET",
			url: "../api/playlist/",
			beforeSend: function(request) {
				request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
			},
			success: function (result, status, request) {
				playlistList = {};
				$("#playlist-list-select").empty();
				for (var i in result) {
					playlistList[result[i].name] = result[i];
					$("#playlist-list-select").append(
						$("<option></option>").val(result[i].name).html(result[i].description||result[i].name)
					);
				}
				if (playlistName) {
					currentStream = playlistList[playlistName];
					$("#playlist-list-select").val(playlistName);
					connectSocket(playlistName);
				}
			},
			error: function (error) {
				showMessage("warning", "Error loading stream list: " + error.status + " - " + error.statusText);
			}
		});
  }
	
	function displayStreamInfo(streamName) {
		runCommand(streamName, "info");
	}
	
	function displayNowPlaying(streamName) {
		runCommand(streamName, "now");
	}
	
	function displayNextPlaying(streamName) {
		runCommand(streamName, "next");
	}
	
	function buildNowPlaying(nowPlayingData) {
		var nowPlaying = "";
		if (nowPlayingData && nowPlayingData.tags) {
			if (nowPlayingData.tags.artist) {
				nowPlaying += nowPlayingData.tags.artist;
			}
			if (nowPlaying) {
				nowPlaying += " - "
			}
			if (nowPlayingData.tags.album) {
				nowPlaying += nowPlayingData.tags.album;
			}
			if (nowPlayingData.tags.date) {
				nowPlaying += " (" + nowPlayingData.tags.date.substring(0,4) + ")";
			}
			if (nowPlaying) {
				nowPlaying += " - "
			}
			if (nowPlayingData.tags.title) {
				nowPlaying += nowPlayingData.tags.title;
			} else {
				nowPlaying += nowPlayingData.name;
			}
		} else {
			nowPlaying += "[No data]";
		}
		return nowPlaying;
	}
  
  function displayHistory(streamName) {
		runCommand(streamName, "history");
  }
	
  function displayPlaylist(streamName) {
		runCommand(streamName, "list");
  }
	
	function connectSocket(streamName) {
    if ($("#stream-connect-websocket").prop("checked")) {
      if (!streamWebsocket[streamName]) {
        if (location.protocol === "https:") {
          streamWebsocket[streamName] = new WebSocket("wss://" + location.hostname + ":" + location.port + location.pathname + "../api/stream/" + currentStream.name + "/ws", ["taliesin"]);
        } else {
          streamWebsocket[streamName] = new WebSocket("ws://" + location.hostname + ":" + location.port + location.pathname + "../api/stream/" + currentStream.name + "/ws", ["taliesin"]);
        }
        streamWebsocket[streamName].onopen = function () {
          streamWebsocket[streamName].send(JSON.stringify({command: "authorization", token: $("#oauth-token-value").val()}));
        }
        streamWebsocket[streamName].onmessage = function (event) {
          handleCommandResponse(streamName, JSON.parse(event.data));
        };
        streamWebsocket[streamName].onclose = function () {
          streamWebsocket[streamName] = false;
          showMessage("info", "Disconnected");
        };
      } else {
        getStreamCover(streamList[streamName]);
      }
    } else {
			currentListIndex = 0;
      streamWebsocket[streamName] = false;
			runCommand(streamName, "info");
			runCommand(streamName, "list");
			getStreamCover(streamList[streamName]);
			if (streamList[streamName].webradio) {
				runCommand(streamName, "history");
				runCommand(streamName, "now");
				runCommand(streamName, "next");
			}
    }
	}
	
	function closeSocket(streamName) {
		if (streamWebsocket[streamName]) {
			streamWebsocket[streamName].close();
		}
	}
	
	function runCommand(streamName, command, parameters) {
		if (streamWebsocket[streamName] && streamWebsocket[streamName].readyState === streamWebsocket[streamName].OPEN) {
			//console.log(JSON.stringify({command: command, parameters: parameters}));
			streamWebsocket[streamName].send(JSON.stringify({command: command, parameters: parameters}));
		} else {
			$.ajax({
				type: "PUT",
				url: "../api/stream/" + currentStream.name + "/manage",
				data: JSON.stringify({command: command, parameters: parameters}),
				beforeSend: function(request) {
					request.setRequestHeader("Authorization", "Bearer " + $("#oauth-token-value").val());
					request.setRequestHeader("content-type", "application/json");
				},
				success: function (result, status, request) {
					handleCommandResponse(streamName, {command: command, result: result||true});
				},
				error: function (error) {
					if (command != "next" || (command == "next" && error.status != 404)) {
						showMessage("warning", "Error stream command: " + error.status + " - " + error.statusText);
					} else {
						$("#stream-current-next-playing").empty();
					}
				}
			});
		}
	}
	
	function handleCommandResponse(streamName, response) {
		//console.log("get command response", response)
		switch (response.command) {
			case "info":
        $("#stream-current-container").show();
        $("#stream-current-display-name").html(response.result.display_name||"No name");
        $("#stream-current-webradio").html(response.result.webradio?"Yes":"No");
        $("#stream-current-random").html(response.result.random?"Yes":"No");
        $("#stream-current-format").html(response.result.format);
        $("#stream-current-channels").html(response.result.stereo?"Stereo":"Mono");
        $("#stream-current-bitrate").html(response.result.bitrate);
        $("#stream-current-sample-rate").html(response.result.sample_rate);
        $("#media-player-stream-url").show().attr("href", "../api/stream/" + response.result.name);
				if (response.result.webradio) {
					$("#media-player-stream-url-playlist").show().attr("href", buildWebradioPlaylist(response.result)).attr("download", response.result.display_name + ".m3u");
				} else {
					$("#media-player-stream-url-playlist").show().attr("href", "../api/stream/" + response.result.name);
				}
				break;
			case "now":
				$("#stream-current-now-playing").html(buildNowPlaying(response.result));
				runCommand(streamName, "next");
				runCommand(streamName, "history");
				getStreamCover(currentStream);
				break;
			case "next":
				$("#stream-current-next-playing").html(buildNowPlaying(response.result));
				break;
			case "stop":
				if ($("#media-player-audio").get()[0] && $("#media-player-audio").get()[0].getAttribute("data-stream-name") === currentStream.name) {
					$("#media-player-audio").get()[0].pause();
					$("#media-player-audio").get()[0].currentTime = 0;
					delete $("#media-player-audio").get()[0];
					$("#media-player-audio").remove();
					$("#media-player-stream-url").hide();
				}
        currentStream = {};
				refreshStreamList();
				break;
			case "replay":
			case "skip":
				showMessage("info", "Stream command Success");
				break;
			case "history":
        $("#stream-history").empty();
        for (var i in response.result) {
          $("#stream-history").append(
						$("<li class=\"list-group-item\"></li>").html((new Date(response.result[i].datestamp * 1000)).toLocaleString() + " - " + buildNowPlaying(response.result[i].media))
					);
        }
				break;
			case "append_list":
			case "remove_list":
			case "play_after":
			case "move":
				if (response.result == true) {
					showMessage("info", "Stream command Success");
					runCommand(streamName, "list");
				} else {
					showMessage("warning", "Stream command error");
				}
				break;
			case "list":
				//console.log(response);
        $("#stream-list").empty();
				var listHeight = Math.floor(Math.log10(response.result.length)+1);
				currentList = response.result;
        for (var i in response.result) {
					var playButton = (!currentStream.webradio?"<button type=\"button\" class=\"btn btn-primary playlist-play\" data-index=\"" + i + "\"><span class=\"glyphicon glyphicon-play\"></span></button>&nbsp;":"");
					var upButton = (i>0?
					"<button type=\"button\" class=\"btn btn-primary playlist-move-up\" data-index=\"" + i + "\">&uarr;</button>&nbsp;":
					"<button type=\"button\" class=\"btn btn-primary playlist-move-up\" data-index=\"" + i + "\" disabled>&uarr;</button>&nbsp;");
					var downButton = (i<response.result.length - 1?
					"<button type=\"button\" class=\"btn btn-primary playlist-move-down\" data-index=\"" + i + "\">&darr;</button>&nbsp;":
					"<button type=\"button\" class=\"btn btn-primary playlist-move-down\" data-index=\"" + i + "\" disabled>&darr;</button>&nbsp;");
          $("#stream-list").append(
						$("<li class=\"list-group-item\"></li>").html(playButton +
																"<button type=\"button\" class=\"btn btn-primary remove-from-playlist\" data-index=\"" + i + "\">X</button>&nbsp;" +
																"<button type=\"button\" class=\"btn btn-primary play-after\" data-index=\"" + i + "\">+</button>&nbsp;" +
																upButton +
																downButton +
																buildNowPlaying(response.result[i]) +
																"<span class=\"badge\">" + pad(i, listHeight) + "</span>")
					);
        }

        $(".play-after").click(function () {
          var index = parseInt($(this).attr("data-index"));
					runCommand(streamName, "play_after", {index: index});
        });
        
        $(".remove-from-playlist").click(function () {
          var index = parseInt($(this).attr("data-index"));
					runCommand(streamName, "remove_list", {index: index});
        });
        
        $(".playlist-move-up").click(function () {
          var index = parseInt($(this).attr("data-index"));
					runCommand(streamName, "move", {index: index, target: (index - 1)});
        });
        
        $(".playlist-move-down").click(function () {
          var index = parseInt($(this).attr("data-index"));
					runCommand(streamName, "move", {index: index, target: (index + 1)});
        });
        
        $(".playlist-play").click(function () {
          var index = parseInt($(this).attr("data-index"));
					
					playNext(index);
        });
				break;
			case "authorization":
				runCommand(streamName, "info");
				runCommand(streamName, "list");
				if (streamList[streamName].webradio) {
					runCommand(streamName, "history");
					runCommand(streamName, "now");
					runCommand(streamName, "next");
				}
				getStreamCover(streamList[streamName]);
				showMessage("info", "Connected");
				break;
		}
		//console.log(response);
	}
	
	function playNext(index) {
		if ($("#media-player-audio").get()[0]) {
			$("#media-player-audio").get()[0].pause();
			$("#media-player-audio").get()[0].currentTime = 0;
			$("#media-player-audio").get()[0].src = URL.createObjectURL(new Blob([], {type:"audio/mp3"}));
			$("#media-player-stream-url").hide();
		}

		if ($("#stream-current-random").prop("checked")) {
			index = parseInt(Math.random() * currentList.length);
		}
		if (index >= currentList.length && $("#stream-current-loop").prop("checked")) {
			index = 0;
		}
		if (index < currentList.length && index >= 0) {
			$("#stream-current-now-playing").html(buildNowPlaying(currentList[index]));
			currentListIndex = index;
			$("#media-player-audio-container").empty();
			$("#media-player-audio-container").html("<audio controls preload=\"none\" id=\"media-player-audio\"></audio>");
			$("#media-player-audio").attr("src", "../api/stream/" + currentStream.name + "?index=" + index + "?rand=" + Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5)).attr("data-stream-name", currentStream.name);
			$("#media-player-audio").trigger("play");
						
			$("#media-player-audio").get()[0].onended = function () {
				playNext(index + 1);
			};
		} else {
			currentListIndex = -1;
		}
	}
	
	function buildWebradioPlaylist(stream) {
		var m3u = "#EXTM3U\n\n#EXTINF:0," + stream.display_name + "\n" + document.location + "../api/stream/" + stream.name + "\n";
		return "data:application/mpegurl;base64," + btoa(m3u);
	}

	function pad(num, size) {
		var s = String(num);
		while (s.length < (size || 2)) {s = "0" + s;}
		return s;
	}
</script>
</html>
